<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Baseball Stats Explorer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(to bottom right, #f8fafc, #dbeafe);
            min-height: 100vh;
            padding: 1rem;
        }
        #root { max-width: 1400px; margin: 0 auto; }
        .chart-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .filters-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }
        h1 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            min-width: 140px;
        }
        select:focus { outline: none; border-color: #3b82f6; }
        .pa-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .pa-filter select {
            min-width: 60px;
        }
        .pa-filter input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            width: 80px;
        }
        button {
            padding: 0.5rem 1rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #dc2626; }
        .chart-wrapper {
            position: relative;
            width: 100%;
            overflow-x: auto;
        }
        svg { display: block; }
        .tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .tooltip div {
            margin: 0.25rem 0;
        }
        .tooltip-player {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        .source {
            position: absolute;
            font-size: 11px;
            color: #6b7280;
            bottom: 10px;
            left: 60px;
        }
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-size: 1.125rem;
        }
        .error {
            text-align: center;
            padding: 3rem;
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const POSITION_MAP = {
            '1': 'P', '2': 'C', '3': '1B', '4': '2B', '5': '3B',
            '6': 'SS', '7': 'LF', '8': 'CF', '9': 'RF', 'D': 'DH', 'H': 'PH'
        };

        const parsePositions = (posStr) => {
            if (!posStr || typeof posStr !== 'string') return [];
            const positions = new Set();
            const cleaned = posStr.replace(/\*/g, '');
            for (let char of cleaned) {
                if (POSITION_MAP[char]) {
                    positions.add(POSITION_MAP[char]);
                }
            }
            return Array.from(positions);
        };

        const parseTeams = (teamStr) => {
            if (!teamStr || typeof teamStr !== 'string') return [];
            return teamStr.split(',').map(t => t.trim());
        };

        function StatsChart() {
            const [allPlayers, setAllPlayers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [hoveredPlayer, setHoveredPlayer] = useState(null);
            const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
            const [selectedTeam, setSelectedTeam] = useState('All Teams');
            const [selectedPosition, setSelectedPosition] = useState('All Positions');
            const [xStat, setXStat] = useState('oWAR');
            const [yStat, setYStat] = useState('dWAR');
            const [paOperator, setPaOperator] = useState('>=');
            const [paValue, setPaValue] = useState('');

            useEffect(() => {
                const sheetId = '1Ffs8hiKfEz9ippfr-yxkN62_i8tflHKaOElIAE26SGc';
                const gid = '0';
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

                Papa.parse(csvUrl, {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        console.log('Loaded players:', results.data.length);
                        console.log('Sample row:', results.data[0]);
                        setAllPlayers(results.data);
                        setLoading(false);
                    },
                    error: (err) => {
                        console.error('Error loading data:', err);
                        setError('Failed to load data');
                        setLoading(false);
                    }
                });
            }, []);

            const statOptions = useMemo(() => {
                if (allPlayers.length === 0) return [];
                const firstPlayer = allPlayers[0];
                return Object.keys(firstPlayer).filter(key => 
                    typeof firstPlayer[key] === 'number' && 
                    !['Season', 'Age', 'G'].includes(key)
                );
            }, [allPlayers]);

            const teams = useMemo(() => {
                const teamSet = new Set();
                allPlayers.forEach(p => {
                    parseTeams(p.Team).forEach(t => teamSet.add(t));
                });
                return ['All Teams', ...Array.from(teamSet).sort()];
            }, [allPlayers]);

            const positions = useMemo(() => {
                const posSet = new Set();
                allPlayers.forEach(p => {
                    parsePositions(p.Pos).forEach(pos => posSet.add(pos));
                });
                return ['All Positions', ...Array.from(posSet).sort()];
            }, [allPlayers]);

            const filteredPlayers = useMemo(() => {
                return allPlayers.filter(player => {
                    // PA filter
                    if (paValue !== '') {
                        const pa = player.PA || 0;
                        const threshold = Number(paValue);
                        if (paOperator === '>=' && pa < threshold) return false;
                        if (paOperator === '<=' && pa > threshold) return false;
                        if (paOperator === '=' && pa !== threshold) return false;
                    }

                    // Team filter
                    if (selectedTeam !== 'All Teams') {
                        const playerTeams = parseTeams(player.Team);
                        if (!playerTeams.includes(selectedTeam)) return false;
                    }

                    // Position filter
                    if (selectedPosition !== 'All Positions') {
                        const playerPositions = parsePositions(player.Pos);
                        if (!playerPositions.includes(selectedPosition)) return false;
                    }

                    return true;
                });
            }, [allPlayers, selectedTeam, selectedPosition, paOperator, paValue]);

            const { xExtent, yExtent } = useMemo(() => {
                if (filteredPlayers.length === 0) return { xExtent: [0, 10], yExtent: [-2, 3] };
                
                const xValues = filteredPlayers.map(p => p[xStat] || 0).filter(v => !isNaN(v));
                const yValues = filteredPlayers.map(p => p[yStat] || 0).filter(v => !isNaN(v));
                
                const xMin = Math.min(...xValues);
                const xMax = Math.max(...xValues);
                const yMin = Math.min(...yValues);
                const yMax = Math.max(...yValues);
                
                const xPadding = (xMax - xMin) * 0.1;
                const yPadding = (yMax - yMin) * 0.1;
                
                return {
                    xExtent: [xMin - xPadding, xMax + xPadding],
                    yExtent: [yMin - yPadding, yMax + yPadding]
                };
            }, [filteredPlayers, xStat, yStat]);

            const resetFilters = () => {
                setSelectedTeam('All Teams');
                setSelectedPosition('All Positions');
                setXStat('oWAR');
                setYStat('dWAR');
                setPaOperator('>=');
                setPaValue('');
            };

            if (loading) return <div className="loading">Loading data...</div>;
            if (error) return <div className="error">{error}</div>;

            const width = 1100;
            const height = 700;
            const margin = { top: 40, right: 40, bottom: 60, left: 60 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const xScale = (value) => {
                return margin.left + ((value - xExtent[0]) / (xExtent[1] - xExtent[0])) * innerWidth;
            };

            const yScale = (value) => {
                return margin.top + innerHeight - ((value - yExtent[0]) / (yExtent[1] - yExtent[0])) * innerHeight;
            };

            const sizeScale = (war) => {
                const maxWar = Math.max(...allPlayers.map(p => p.WAR || 0));
                return 3 + (war / maxWar) * 17;
            };

            const xTicks = [];
            const xStep = (xExtent[1] - xExtent[0]) / 8;
            for (let i = 0; i <= 8; i++) {
                xTicks.push(xExtent[0] + xStep * i);
            }

            const yTicks = [];
            const yStep = (yExtent[1] - yExtent[0]) / 8;
            for (let i = 0; i <= 8; i++) {
                yTicks.push(yExtent[0] + yStep * i);
            }

            return (
                <div className="chart-container">
                    <div className="header-row">
                        <div>
                            <h1>2025 Baseball Stats Explorer</h1>
                            <p className="subtitle">Interactive player statistics (bubble size = total WAR)</p>
                        </div>
                        <div className="filters-container">
                            <div className="filter-group">
                                <label>X-Axis</label>
                                <select value={xStat} onChange={(e) => setXStat(e.target.value)}>
                                    {statOptions.map(stat => (
                                        <option key={stat} value={stat}>{stat}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="filter-group">
                                <label>Y-Axis</label>
                                <select value={yStat} onChange={(e) => setYStat(e.target.value)}>
                                    {statOptions.map(stat => (
                                        <option key={stat} value={stat}>{stat}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="filter-group">
                                <label>Team</label>
                                <select value={selectedTeam} onChange={(e) => setSelectedTeam(e.target.value)}>
                                    {teams.map(team => (
                                        <option key={team} value={team}>{team}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="filter-group">
                                <label>Position</label>
                                <select value={selectedPosition} onChange={(e) => setSelectedPosition(e.target.value)}>
                                    {positions.map(pos => (
                                        <option key={pos} value={pos}>{pos}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="filter-group">
                                <label>Min PA</label>
                                <div className="pa-filter">
                                    <select value={paOperator} onChange={(e) => setPaOperator(e.target.value)}>
                                        <option value=">=">≥</option>
                                        <option value="<=">≤</option>
                                        <option value="=">=</option>
                                    </select>
                                    <input 
                                        type="number" 
                                        value={paValue}
                                        onChange={(e) => setPaValue(e.target.value)}
                                        placeholder="PA"
                                    />
                                </div>
                            </div>
                            <button onClick={resetFilters}>Reset</button>
                        </div>
                    </div>

                    <div className="chart-wrapper">
                        <svg 
                            width={width} 
                            height={height}
                            onMouseMove={(e) => setMousePos({ x: e.clientX, y: e.clientY })}
                        >
                            {/* Grid lines */}
                            {xTicks.map(tick => (
                                <line
                                    key={`x-grid-${tick}`}
                                    x1={xScale(tick)}
                                    y1={margin.top}
                                    x2={xScale(tick)}
                                    y2={height - margin.bottom}
                                    stroke="#e5e7eb"
                                    strokeWidth="1"
                                />
                            ))}
                            {yTicks.map(tick => (
                                <line
                                    key={`y-grid-${tick}`}
                                    x1={margin.left}
                                    y1={yScale(tick)}
                                    x2={width - margin.right}
                                    y2={yScale(tick)}
                                    stroke="#e5e7eb"
                                    strokeWidth="1"
                                />
                            ))}

                            {/* Axes */}
                            <line
                                x1={margin.left}
                                y1={height - margin.bottom}
                                x2={width - margin.right}
                                y2={height - margin.bottom}
                                stroke="#374151"
                                strokeWidth="2"
                            />
                            <line
                                x1={margin.left}
                                y1={margin.top}
                                x2={margin.left}
                                y2={height - margin.bottom}
                                stroke="#374151"
                                strokeWidth="2"
                            />

                            {/* X-axis ticks and labels */}
                            {xTicks.map(tick => (
                                <g key={`x-tick-${tick}`}>
                                    <line
                                        x1={xScale(tick)}
                                        y1={height - margin.bottom}
                                        x2={xScale(tick)}
                                        y2={height - margin.bottom + 6}
                                        stroke="#374151"
                                        strokeWidth="2"
                                    />
                                    <text
                                        x={xScale(tick)}
                                        y={height - margin.bottom + 20}
                                        textAnchor="middle"
                                        fontSize="12"
                                        fill="#6b7280"
                                    >
                                        {tick.toFixed(1)}
                                    </text>
                                </g>
                            ))}

                            {/* Y-axis ticks and labels */}
                            {yTicks.map(tick => (
                                <g key={`y-tick-${tick}`}>
                                    <line
                                        x1={margin.left - 6}
                                        y1={yScale(tick)}
                                        x2={margin.left}
                                        y2={yScale(tick)}
                                        stroke="#374151"
                                        strokeWidth="2"
                                    />
                                    <text
                                        x={margin.left - 10}
                                        y={yScale(tick)}
                                        textAnchor="end"
                                        dominantBaseline="middle"
                                        fontSize="12"
                                        fill="#6b7280"
                                    >
                                        {tick.toFixed(1)}
                                    </text>
                                </g>
                            ))}

                            {/* Axis labels */}
                            <text
                                x={width / 2}
                                y={height - 10}
                                textAnchor="middle"
                                fontSize="14"
                                fontWeight="600"
                                fill="#374151"
                            >
                                {xStat}
                            </text>
                            <text
                                x={-height / 2}
                                y={15}
                                textAnchor="middle"
                                fontSize="14"
                                fontWeight="600"
                                fill="#374151"
                                transform={`rotate(-90)`}
                            >
                                {yStat}
                            </text>

                            {/* Data points */}
                            {filteredPlayers.map((player, i) => {
                                const x = xScale(player[xStat] || 0);
                                const y = yScale(player[yStat] || 0);
                                const r = sizeScale(player.WAR || 0);
                                
                                return (
                                    <circle
                                        key={i}
                                        cx={x}
                                        cy={y}
                                        r={r}
                                        fill="#3b82f6"
                                        fillOpacity="0.6"
                                        stroke="#2563eb"
                                        strokeWidth="1"
                                        onMouseEnter={() => setHoveredPlayer(player)}
                                        onMouseLeave={() => setHoveredPlayer(null)}
                                        style={{ cursor: 'pointer' }}
                                    />
                                );
                            })}
                        </svg>

                        {hoveredPlayer && (
                            <div 
                                className="tooltip"
                                style={{ 
                                    left: mousePos.x + 15,
                                    top: mousePos.y - 15
                                }}
                            >
                                <div className="tooltip-player">{hoveredPlayer.Player}</div>
                                <div>Team: {hoveredPlayer.Team}</div>
                                <div>Position: {hoveredPlayer.Pos}</div>
                                <div>Total WAR: {(hoveredPlayer.WAR || 0).toFixed(1)}</div>
                                <div>{xStat}: {(hoveredPlayer[xStat] || 0).toFixed(1)}</div>
                                <div>{yStat}: {(hoveredPlayer[yStat] || 0).toFixed(1)}</div>
                                <div>PA: {hoveredPlayer.PA || 0}</div>
                            </div>
                        )}
                        
                        <div className="source">
                            Source: Baseball Reference
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<StatsChart />, document.getElementById('root'));
    </script>
</body>
</html>
